<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>그릴마당 마작 레이팅</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <!-- 상단 헤더: 왼쪽 제목 / 오른쪽 뷰 전환 -->
  <div class="top-bar">
    <h1>그릴마당 마작 레이팅</h1>
    <div class="view-switch">
      <button class="view-switch-btn active" data-view="personal">개인 레이팅</button>
      <button class="view-switch-btn" data-view="stats">개인별 통계</button>
      <button class="view-switch-btn" data-view="tournament">대회 전용</button>
      <button class="view-switch-btn" data-view="archive">아카이브</button>
      <button class="view-switch-btn" data-view="admin">관리자 기능</button>
    </div>
  </div>

  <!-- ================= 개인 레이팅 화면 ================= -->
  <div id="personal-view" class="view">
    <div class="main-layout equal-layout">
      <!-- 왼쪽: 입력 + 게임 데이터 + 규칙 -->
      <div class="left-panel">
        <!-- 입력 폼 -->
        <section class="form-panel">
          <h2>대국 기록 입력</h2>
          <form id="game-form" method="post" autocomplete="off">
            <div class="row">
              <label>P1(동)</label>
              <input name="player1_name" placeholder="플레이어 1 이름" required>
              <input name="player1_score"
                     type="text"
                     placeholder="점수"
                     required>
            </div>
            <div class="row">
              <label>P2(남)</label>
              <input name="player2_name" placeholder="플레이어 2 이름" required>
              <input name="player2_score"
                     type="text"
                     placeholder="점수"
                     required>
            </div>
            <div class="row">
              <label>P3(서)</label>
              <input name="player3_name" placeholder="플레이어 3 이름" required>
              <input name="player3_score"
                     type="text"
                     placeholder="점수"
                     required>
            </div>
            <div class="row">
              <label>P4(북)</label>
              <input name="player4_name" placeholder="플레이어 4 이름" required>
              <input name="player4_score"
                     type="text"
                     placeholder="점수"
                     required>
            </div>
            <button type="submit">저장</button>
          </form>
        </section>

        <!-- 대국 기록 + CSV -->
        <section class="games-panel">
          <div class="games-header">
            <h2>대국 기록</h2>
            <div class="games-header-right">
              <a href="/export" class="export-link">CSV 내보내기</a>
              <a href="/import" class="import-link">CSV 업로드</a>
            </div>
          </div>

          <table class="games-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>시간</th>
                <th>P1</th>
                <th>P2</th>
                <th>P3</th>
                <th>P4</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="games-tbody">
            </tbody>
          </table>
        </section>

        <!-- 룰 안내 -->
        <section class="rule-panel">
          <h2>레이팅전 규칙</h2>
          <ul>
            <li>4인 반장전, 서입 O, 북입 X</li>
            <li>25,000점 시작, 30,000점 반환</li>
            <li>토비 시 게임 종료</li>
            <li>우마: 1등 +30 / 2등 +10 / 3등 −10 / 4등 −30</li>
            <li>오카: 1등 +20</li>
            <li>발성미스: 화료 불가</li>
            <li>촌보: 3000 all</li>
          </ul>
        </section>
      </div>

      <!-- 오른쪽: 개인 전체 등수 -->
      <div class="right-panel">
        <section class="ranking-panel">
          <div class="ranking-header">
            <h2>전체 등수</h2>
            <div class="rank-legend">
              <span class="legend-color legend1"></span><span class="legend-text">1등</span>
              <span class="legend-color legend2"></span><span class="legend-text">2등</span>
              <span class="legend-color legend3"></span><span class="legend-text">3등</span>
              <span class="legend-color legend4"></span><span class="legend-text">4등</span>
            </div>
          </div>

          <table class="ranking-table" id="ranking-table">
            <thead>
              <tr>
                <th>순위</th>
                <th>이름</th>

                <th class="sortable" data-sort-key="games">
                  게임 수
                </th>

                <th class="sortable" data-sort-key="total_pt">
                  총 pt
                </th>

                <th class="sortable" data-sort-key="avg_pt">
                  평균 pt
                </th>

                <th class="sortable" data-sort-key="yonde_rate">
                  연대율
                </th>

                <th>등수 분포</th>
              </tr>
            </thead>
            <tbody id="ranking-tbody">
              <tr>
                <td colspan="7" class="ranking-placeholder">통계 없음</td>
              </tr>
            </tbody>
          </table>
        </section>
      </div>
    </div>
  </div>

  <!-- ================= 개인별 통계 화면 ================= -->
  <div id="stats-view" class="view" style="display:none;">
    <div class="main-layout">
      <div class="left-panel">

        <!-- (2) 개인별 통계 -->
        <section class="stats-panel">
          <h2>개인별 통계</h2>
          <div class="stats-player-select">
            <label for="stats-player-select">플레이어 선택</label>
            <select id="stats-player-select">
              <option value="">플레이어를 선택하세요</option>
            </select>
          </div>
          <div id="stats-summary" class="stats-summary">
            <p class="hint-text">왼쪽에서 플레이어를 선택하세요.</p>
          </div>
        </section>

        <!-- (3) 총 등수 통계 -->
        <section class="stats-panel">
          <h3>총 등수 통계</h3>
          <div id="stats-rank-dist" class="stats-rank-dist"></div>
          <div id="stats-rank-numbers" class="stats-rank-numbers"></div>
        </section>

                <!-- (4) 개인 대국 기록 -->
        <section class="stats-panel">
          <h3>개인 대국 기록</h3>
          <table class="games-table">
            <thead>
              <tr>
                <th>시간</th>
                <th>P1</th>
                <th>P2</th>
                <th>P3</th>
                <th>P4</th>
              </tr>
            </thead>
            <tbody id="stats-player-games-tbody">
              <tr>
                <td colspan="5" class="ranking-placeholder">
                  플레이어를 선택하면 기록이 표시됩니다.
                </td>
              </tr>
            </tbody>
          </table>
        </section>
      </div>

      <div class="right-panel">
        <section class="stats-panel">
          <h3>최근 등수 그래프</h3>
          <div id="stats-recent-ranks" class="recent-rank-graph">
            <p class="hint-text">플레이어를 선택하면 최근 등수 그래프가 표시됩니다.</p>
          </div>
        </section>

        <section class="stats-panel">
          <h3>같이 한 플레이어별 기록</h3>
          <table class="stats-co-table">
            <thead>
              <tr>
                <th>플레이어</th>
                <th>같이 한 판 수</th>
                <th>내 평균 등수</th>
                <th>상대 평균 등수</th>
              </tr>
            </thead>
            <tbody id="stats-co-tbody">
              <tr>
                <td colspan="4" class="ranking-placeholder">데이터 없음</td>
              </tr>
            </tbody>
          </table>
        </section>

        <!-- (1) 보유 뱃지 -->
        <section class="stats-panel">
          <h2>보유 뱃지</h2>
          <div id="stats-badges" class="badge-list">
            <p class="hint-text">플레이어를 선택하면 보유 뱃지가 표시됩니다.</p>
          </div>
        </section>

      </div>
    </div>
  </div>

  <!-- ================= 대회 전용 화면 (개인 레이팅 복제) ================= -->
  <div id="tournament-view" class="view" style="display:none;">
    <div class="main-layout equal-layout">
      <!-- 왼쪽: 입력 + 게임 데이터 + 규칙 -->
      <div class="left-panel">

        <section class="form-panel">
          <h2>대회 대국 기록 입력</h2>
          <form id="tournament-game-form" method="post" autocomplete="off">
            <div class="row">
              <label>P1(동)</label>
              <input name="player1_name" placeholder="플레이어 1 이름" required>
              <input name="player1_score" type="text" placeholder="점수" required>
            </div>
            <div class="row">
              <label>P2(남)</label>
              <input name="player2_name" placeholder="플레이어 2 이름" required>
              <input name="player2_score" type="text" placeholder="점수" required>
            </div>
            <div class="row">
              <label>P3(서)</label>
              <input name="player3_name" placeholder="플레이어 3 이름" required>
              <input name="player3_score" type="text" placeholder="점수" required>
            </div>
            <div class="row">
              <label>P4(북)</label>
              <input name="player4_name" placeholder="플레이어 4 이름" required>
              <input name="player4_score" type="text" placeholder="점수" required>
            </div>
            <button type="submit">저장</button>
          </form>
        </section>

        <section class="games-panel">
          <div class="games-header">
            <h2>대회 대국 기록</h2>
            <div class="games-header-right">
              <a href="/export_tournament" class="export-link">CSV 내보내기</a>
              <a href="/import_tournament" class="import-link">CSV 업로드</a>
            </div>
          </div>

          <table class="games-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>시간</th>
                <th>P1</th>
                <th>P2</th>
                <th>P3</th>
                <th>P4</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tournament-games-tbody"></tbody>
          </table>
        </section>

        <section class="rule-panel">
          <h2>대회 규칙</h2>
          <ul>
            <li>대회 전용 창입니다</li>
          </ul>
        </section>
      </div>

      <!-- 오른쪽: 전체 등수 -->
      <div class="right-panel">
        <section class="ranking-panel">
          <div class="ranking-header">
            <h2>대회 전체 등수</h2>
            <div class="rank-legend">
              <span class="legend-color legend1"></span><span class="legend-text">1등</span>
              <span class="legend-color legend2"></span><span class="legend-text">2등</span>
              <span class="legend-color legend3"></span><span class="legend-text">3등</span>
              <span class="legend-color legend4"></span><span class="legend-text">4등</span>
            </div>
          </div>

          <table class="ranking-table">
            <thead>
              <tr>
                <th>순위</th>
                <th>이름</th>
                <th>게임 수</th>
                <th>총 pt</th>
                <th>평균 pt</th>
                <th>연대율</th>
                <th>등수 분포</th>
              </tr>
            </thead>
            <tbody id="tournament-ranking-tbody">
              <tr><td colspan="7" class="ranking-placeholder">통계 없음</td></tr>
            </tbody>
          </table>
        </section>
      </div>
    </div>
  </div>


    <!-- ================= 아카이브 화면 ================= -->
  <div id="archive-view" class="view" style="display:none;">
    <div class="main-layout">
      <!-- 왼쪽: 아카이브 선택 + 대국 기록 -->
      <div class="left-panel">
        <section class="stats-panel">
          <h2>아카이브 선택</h2>
          <div class="stats-player-select">
            <label for="archive-select">아카이브</label>
            <select id="archive-select">
              <option value="">아카이브를 선택하세요</option>
            </select>
          </div>
          <p class="hint-text">
            관리자 기능에서 CSV 파일을 업로드해 시즌 아카이브를 등록할 수 있습니다.
          </p>
        </section>

        <section class="stats-panel">
          <h3>아카이브 대국 기록</h3>
          <table class="games-table">
            <thead>
              <tr>
                <th>시간</th>
                <th>P1</th>
                <th>P2</th>
                <th>P3</th>
                <th>P4</th>
              </tr>
            </thead>
            <tbody id="archive-games-tbody">
              <tr>
                <td colspan="5" class="ranking-placeholder">아카이브를 선택하세요.</td>
              </tr>
            </tbody>
          </table>
        </section>
      </div>

      <!-- 오른쪽: 전체 등수 (아카이브 기준) -->
      <div class="right-panel">
        <section class="ranking-panel">
          <div class="ranking-header">
            <h2>전체 등수 (아카이브)</h2>
            <div class="rank-legend">
              <span class="legend-color legend1"></span><span class="legend-text">1등</span>
              <span class="legend-color legend2"></span><span class="legend-text">2등</span>
              <span class="legend-color legend3"></span><span class="legend-text">3등</span>
              <span class="legend-color legend4"></span><span class="legend-text">4등</span>
            </div>
          </div>

          <table class="ranking-table" id="archive-ranking-table">
            <thead>
              <tr>
                <th>순위</th>
                <th>이름</th>

                <th class="sortable" data-sort-key="games">
                  게임 수
                </th>

                <th class="sortable" data-sort-key="total_pt">
                  총 pt
                </th>

                <th class="sortable" data-sort-key="avg_pt">
                  평균 pt
                </th>

                <th class="sortable" data-sort-key="yonde_rate">
                  연대율
                </th>

                <th>등수 분포</th>
              </tr>
            </thead>
            <tbody id="archive-ranking-tbody"></tbody>
          </table>

        </section>
      </div>
    </div>
  </div>


  <!-- ================= 관리자 기능 화면 ================= -->
  <div id="admin-view" class="view" style="display:none;">
    <div class="main-layout">
      <div class="left-panel">
        <section class="admin-panel">
          <section class="admin-panel">
            <h3>뱃지 CSV 백업 / 복원</h3>
            <div class="games-header-right">
              <a href="/export_badges" class="export-link">뱃지 목록 CSV</a>
              <a href="/import_badges" class="import-link">뱃지 목록 업로드</a>
            </div>
            <div class="games-header-right" style="margin-top:6px;">
              <a href="/export_player_badges" class="export-link">뱃지 부여 CSV</a>
              <a href="/import_player_badges" class="import-link">뱃지 부여 업로드</a>
            </div>
            <p class="hint-text" style="margin-top:6px;">
              업로드는 “추가/갱신(뱃지)” + “추가(부여 목록, 중복 자동 스킵)” 방식입니다.
            </p>
          </section>

          <h2>뱃지 목록</h2>
          <table class="badge-table">
            <thead>
              <tr>
                <th>코드</th>
                <th>이름</th>
                <th>등급</th>
                <th>설명</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="badge-list-tbody">
              <tr>
                <td colspan="5" class="ranking-placeholder">등록된 뱃지가 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </section>

        <section class="admin-panel">
          <h3>새 뱃지 추가</h3>
          <form id="badge-create-form" autocomplete="off">
            <div class="form-row">
              <label>코드</label>
              <input type="number" name="code" placeholder="예: 1001" required>
            </div>
            <div class="form-row">
              <label>이름</label>
              <input type="text" name="name" placeholder="뱃지 이름" required>
            </div>
            <div class="form-row">
              <label>등급</label>
              <select name="grade" required>
                <option value="플래티넘">플래티넘</option>
                <option value="골드">골드</option>
                <option value="실버">실버</option>
                <option value="브론즈">브론즈</option>
                <option value="기타">기타</option>
              </select>
            </div>
            <div class="form-row">
              <label>설명</label>
              <input type="text" name="description" placeholder="예: 시즌1 pt 1등">
            </div>
            <button type="submit">추가</button>
          </form>
        </section>

        <section class="admin-panel">
          <h3>아카이브 생성 (CSV 업로드)</h3>
          <p class="hint-text">
            한 시즌의 대국 기록이 담긴 CSV 파일을 업로드하면<br>
            새 아카이브로 저장됩니다. (형식은 /export 로 받은 CSV와 동일하면 편해요.)
          </p>
          <form id="archive-upload-form"
                method="post"
                action="/admin/archive_import"
                enctype="multipart/form-data"
                autocomplete="off">
            <div class="form-row">
              <label>아카이브 이름</label>
              <input type="text" name="archive_name" placeholder="예: 2024 시즌 1" required>
            </div>
            <div class="form-row">
              <label>CSV 파일</label>
              <input type="file" name="file" accept=".csv" required>
            </div>
            <button type="submit">업로드</button>
          </form>
        </section>

        <section class="admin-panel">
          <h3>아카이브 목록</h3>
          <table class="badge-table">
            <thead>
              <tr>
                <th>이름</th>
                <th>생성 시각</th>
                <th>게임 수</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="archive-list-tbody">
              <tr>
                <td colspan="4" class="ranking-placeholder">등록된 아카이브가 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </section>
      </div>

      <div class="right-panel">
        <section class="admin-panel">
          <h2>플레이어 뱃지 관리</h2>
          <div class="admin-player-select">
            <input type="text" id="admin-player-name" placeholder="플레이어 이름 입력">
            <button id="admin-load-player">불러오기</button>
          </div>
          <div id="admin-player-badges" class="badge-list">
            <p class="hint-text">플레이어 이름을 입력하고 '불러오기'를 눌러주세요.</p>
          </div>
        </section>

        <section class="admin-panel">
          <h3>뱃지 부여</h3>
          <form id="badge-assign-form" autocomplete="off">
            <div class="form-row">
              <label>플레이어</label>
              <input type="text" id="badge-assign-player" name="player_name" placeholder="플레이어 이름" required>
            </div>
            <div class="form-row">
              <label>뱃지 코드</label>
              <select id="badge-assign-code" name="badge_code" required>
                <option value="">뱃지를 선택하세요</option>
              </select>
            </div>
            <button type="submit">부여</button>
          </form>
        </section>

        <section class="admin-panel">
          <h3>개인전 기록 초기화</h3>
          <p class="hint-text">
            새 시즌 시작 시 사용하세요.<br>
            모든 개인전 대국 기록이 삭제되며, 되돌릴 수 없습니다.
          </p>
          <button id="reset-games-btn">개인전 기록 전체 삭제</button>
        </section>

      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
